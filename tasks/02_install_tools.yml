---
- name: Create Python tools directory
  block:
    - name: Ensure Python tool install directory exists
      ansible.builtin.file:
        path: "{{ python_tool_install_path }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Ensure Python tool venv base directory exists
      ansible.builtin.file:
        path: "{{ python_tool_venv_dir }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Add Python tool path script in /etc/profile.d
      ansible.builtin.copy:
        dest: /etc/profile.d/python_path.sh
        content: |
          #!/bin/sh
          # Add Python Tool bin to the PATH for all users
          if [ -d "$HOME/{{ python_tool_install_dir }}" ]; then
              PATH="$HOME/{{ python_tool_install_dir }}:$PATH"
          fi
        mode: "0644"
        owner: root
        group: root
      become: true

- name: Install tool dependencies
  block:
    - name: Collect tool dependencies for current OS
      ansible.builtin.set_fact:
        python_tool_dep_pkgs: "{{ python_tools | selectattr('tool_dependencies', 'defined') | map(attribute='tool_dependencies') | map('dict2items') | flatten | selectattr('key', 'equalto', ansible_os_family) | map(attribute='value') | flatten | unique | list }}"

    - name: Install OS-specific tool dependencies
      ansible.builtin.include_tasks: "{{ task_file }}"
      with_first_found:
        - "{{ role_path }}/tasks/noauto_install_tool_dep_{{ ansible_distribution }}-{{ ansible_distribution_major_version }}.yml"
        - "{{ role_path }}/tasks/noauto_install_tool_dep_{{ ansible_os_family }}-{{ ansible_distribution_major_version }}.yml"
        - "{{ role_path }}/tasks/noauto_install_tool_dep_{{ ansible_distribution }}.yml"
        - "{{ role_path }}/tasks/noauto_install_tool_dep_{{ ansible_os_family }}.yml"
        - "{{ role_path }}/tasks/noauto_install_tool_dep_{{ ansible_lsb.id }}.yml"
      loop_control:
        loop_var: task_file
      when: python_tool_dep_pkgs is defined and python_tool_dep_pkgs | length > 0

- name: Install Python packages
  block:
    - name: Check if version file exists
      ansible.builtin.stat:
        path: "{{ python_tool_version_file_path }}"
      register: python_tool_file

    - name: Read Python tool version file
      ansible.builtin.slurp:
        src: "{{ python_tool_version_file_path }}"
      register: python_tool_version_file_content
      when: python_tool_file.stat.exists

    - name: Parse Python tool versions
      ansible.builtin.set_fact:
        python_tool_installed_versions: "{{ (python_tool_version_file_content.content | b64decode | from_json) if python_tool_file.stat.exists else {} }}"

    - name: Normalize tools with venv_name defaults
      ansible.builtin.set_fact:
        python_tools_normalized: >-
          {%- set normalized = [] -%}
          {%- for tool in python_tools -%}
            {%- set tool_with_venv = tool | combine({'venv_name': tool.venv_name | default(tool.package)}) -%}
            {%- set _ = normalized.append(tool_with_venv) -%}
          {%- endfor -%}
          {{ normalized }}

    - name: Group tools by venv_name
      ansible.builtin.set_fact:
        python_tools_by_venv: "{{ python_tools_normalized | groupby('venv_name') | items2dict(key_name=0, value_name=1) }}"

    - name: Determine which venvs need updates
      ansible.builtin.set_fact:
        python_venvs_to_update: >-
          {%- set venvs_to_update = [] -%}
          {%- for venv_name, tools in python_tools_by_venv.items() -%}
            {%- for tool in tools -%}
              {%- set version_key = tool.package + '@' + tool.venv_name -%}
              {%- if version_key not in python_tool_installed_versions or python_tool_installed_versions[version_key] != tool.version -%}
                {%- if venv_name not in venvs_to_update -%}
                  {%- set _ = venvs_to_update.append(venv_name) -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
          {{ venvs_to_update }}

    - name: Create venv directories
      ansible.builtin.file:
        path: "{{ python_tool_venv_dir }}/{{ venv_name }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop: "{{ python_venvs_to_update }}"
      loop_control:
        loop_var: venv_name

    - name: Create virtual environments
      ansible.builtin.command:
        cmd: "python3 -m venv {{ python_tool_venv_dir }}/{{ venv_name }}/venv"
        creates: "{{ python_tool_venv_dir }}/{{ venv_name }}/venv/bin/python"
      loop: "{{ python_venvs_to_update }}"
      loop_control:
        loop_var: venv_name

    - name: Install all packages for each venv
      ansible.builtin.pip:
        name: >-
          {%- set packages = [] -%}
          {%- for tool in python_tools_by_venv[venv_name] -%}
            {%- set pkg_spec = tool.package + ('==' + tool.version if tool.version != 'latest' else '') -%}
            {%- set _ = packages.append(pkg_spec) -%}
          {%- endfor -%}
          {{ packages }}
        state: present
        virtualenv: "{{ python_tool_venv_dir }}/{{ venv_name }}/venv"
      loop: "{{ python_venvs_to_update }}"
      loop_control:
        loop_var: venv_name

    - name: Create wrapper scripts for tool binaries
      ansible.builtin.template:
        src: tool-wrapper.sh.j2
        dest: "{{ python_tool_install_path }}/{{ executable }}"
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop: "{{ python_tools_normalized | subelements('executables') }}"
      loop_control:
        loop_var: tool_executable
      vars:
        tool: "{{ tool_executable[0] }}"
        executable: "{{ tool_executable[1] }}"

    - name: Update installed versions
      ansible.builtin.set_fact:
        python_tool_installed_versions: "{{ python_tool_installed_versions | combine({tool.package + '@' + tool.venv_name: tool.version}) }}"
      loop: "{{ python_tools_normalized }}"
      loop_control:
        loop_var: tool

    - name: Update tool version file
      ansible.builtin.copy:
        content: "{{ python_tool_installed_versions | to_nice_json }}"
        dest: "{{ python_tool_version_file_path }}"
        mode: 0644
        owner: root
        group: root
      become: true
