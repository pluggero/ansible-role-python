---
- name: Create Python tools directory
  block:
    - name: Ensure Python tool install directory exists
      ansible.builtin.file:
        path: "{{ python_tool_install_path }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Ensure Python tool venv base directory exists
      ansible.builtin.file:
        path: "{{ python_tool_venv_dir }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Add Python tool path script in /etc/profile.d
      ansible.builtin.copy:
        dest: /etc/profile.d/python_path.sh
        content: |
          #!/bin/sh
          # Add Python Tool bin to the PATH for all users
          if [ -d "$HOME/{{ python_tool_install_dir }}" ]; then
              PATH="$HOME/{{ python_tool_install_dir }}:$PATH"
          fi
        mode: "0644"
        owner: root
        group: root
      become: true

- name: Install tool dependencies
  block:
    - name: Collect tool dependencies for current OS
      ansible.builtin.set_fact:
        python_tool_dep_pkgs: "{{ python_tools | selectattr('tool_dependencies', 'defined') | map(attribute='tool_dependencies') | map('dict2items') | flatten | selectattr('key', 'equalto', ansible_os_family) | map(attribute='value') | flatten | unique | list }}"

    - name: Install OS-specific tool dependencies
      ansible.builtin.include_tasks: "{{ task_file }}"
      with_first_found:
        - "noauto_install_tool_dep_{{ ansible_distribution }}-{{ ansible_distribution_major_version }}.yml"
        - "noauto_install_tool_dep_{{ ansible_os_family }}-{{ ansible_distribution_major_version }}.yml"
        - "noauto_install_tool_dep_{{ ansible_distribution }}.yml"
        - "noauto_install_tool_dep_{{ ansible_os_family }}.yml"
        - "noauto_install_tool_dep_{{ ansible_lsb.id }}.yml"
      loop_control:
        loop_var: task_file
      when: python_tool_dep_pkgs is defined and python_tool_dep_pkgs | length > 0

- name: Install Python packages
  block:
    - name: Check if version file exists
      ansible.builtin.stat:
        path: "{{ python_tool_version_file_path }}"
      register: python_tool_file

    - name: Read Python tool version file
      ansible.builtin.slurp:
        src: "{{ python_tool_version_file_path }}"
      register: python_tool_version_file_content
      when: python_tool_file.stat.exists

    - name: Parse Python tool versions
      ansible.builtin.set_fact:
        python_tool_installed_versions: "{{ (python_tool_version_file_content.content | b64decode | from_json) if python_tool_file.stat.exists else {} }}"

    - name: Create tool-specific venv directories
      ansible.builtin.file:
        path: "{{ python_tool_venv_dir }}/{{ tool.package }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop: "{{ python_tools }}"
      loop_control:
        loop_var: tool
      when: >
        tool.package not in python_tool_installed_versions or
        python_tool_installed_versions[tool.package] != tool.version

    - name: Create virtual environments for tools
      ansible.builtin.command:
        cmd: "python3 -m venv {{ python_tool_venv_dir }}/{{ tool.package }}/venv"
        creates: "{{ python_tool_venv_dir }}/{{ tool.package }}/bin/python"
      loop: "{{ python_tools }}"
      loop_control:
        loop_var: tool
      when: >
        tool.package not in python_tool_installed_versions or
        python_tool_installed_versions[tool.package] != tool.version

    - name: Install Python packages in their venvs
      ansible.builtin.pip:
        name: "{{ tool.package }}{{ '==' + tool.version if tool.version != 'latest' else '' }}"
        state: "{{ 'latest' if tool.version == 'latest' else 'present' }}"
        virtualenv: "{{ python_tool_venv_dir }}/{{ tool.package }}/venv"
      register: python_tool_install_result
      loop: "{{ python_tools }}"
      loop_control:
        loop_var: tool
      when: >
        tool.package not in python_tool_installed_versions or
        python_tool_installed_versions[tool.package] != tool.version

    - name: Create wrapper scripts for tool binaries
      ansible.builtin.template:
        src: tool-wrapper.sh.j2
        dest: "{{ python_tool_install_path }}/{{ executable }}"
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop: "{{ python_tools | subelements('executables') }}"
      loop_control:
        loop_var: tool_executable
      vars:
        tool: "{{ tool_executable[0] }}"
        executable: "{{ tool_executable[1] }}"
      when: >
        tool.package not in python_tool_installed_versions or
        python_tool_installed_versions[tool.package] != tool.version

    - name: Update installed versions
      ansible.builtin.set_fact:
        python_tool_installed_versions: "{{ python_tool_installed_versions | combine({tool.package: tool.version}) }}"
      loop: "{{ python_tools }}"
      loop_control:
        loop_var: tool
      when: >
        tool.package not in python_tool_installed_versions or
        python_tool_installed_versions[tool.package] != tool.version

    - name: Update tool version file
      ansible.builtin.copy:
        content: "{{ python_tool_installed_versions | to_nice_json }}"
        dest: "{{ python_tool_version_file_path }}"
        mode: 0644
        owner: root
        group: root
      become: true
