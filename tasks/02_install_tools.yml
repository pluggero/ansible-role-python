---
# Main orchestrator for Python tools installation
# Supports both user-scoped and system-scoped installations

- name: Install tool dependencies
  block:
    - name: Collect tool dependencies for current OS
      ansible.builtin.set_fact:
        python_tool_dep_pkgs: "{{ python_tools | selectattr('tool_dependencies', 'defined') | map(attribute='tool_dependencies') | map('dict2items') | flatten | selectattr('key', 'equalto', ansible_os_family) | map(attribute='value') | flatten | unique | list }}"

    - name: Install OS-specific tool dependencies
      ansible.builtin.include_tasks: "{{ task_file }}"
      with_first_found:
        - "{{ role_path }}/tasks/noauto_install_tools_dep_{{ ansible_distribution }}-{{ ansible_distribution_major_version }}.yml"
        - "{{ role_path }}/tasks/noauto_install_tools_dep_{{ ansible_os_family }}-{{ ansible_distribution_major_version }}.yml"
        - "{{ role_path }}/tasks/noauto_install_tools_dep_{{ ansible_distribution }}.yml"
        - "{{ role_path }}/tasks/noauto_install_tools_dep_{{ ansible_os_family }}.yml"
        - "{{ role_path }}/tasks/noauto_install_tools_dep_{{ ansible_lsb.id }}.yml"
      loop_control:
        loop_var: task_file
      when: python_tool_dep_pkgs is defined and python_tool_dep_pkgs | length > 0

- name: Normalize tools with defaults
  ansible.builtin.set_fact:
    python_tools_normalized: >-
      {%- set normalized = [] -%}
      {%- for tool in python_tools -%}
        {%- set tool_with_defaults = tool | combine({
            'venv_name': tool.venv_name | default(tool.package),
            'install_scope': tool.install_scope | default('user')
        }) -%}
        {%- set _ = normalized.append(tool_with_defaults) -%}
      {%- endfor -%}
      {{ normalized }}

- name: Split tools by scope
  ansible.builtin.set_fact:
    python_tools_user: "{{ python_tools_normalized | selectattr('install_scope', 'equalto', 'user') | list }}"
    python_tools_system: "{{ python_tools_normalized | selectattr('install_scope', 'equalto', 'system') | list }}"

- name: Install user-scoped Python tools
  ansible.builtin.include_tasks: noauto_install_tools_user.yml
  when: python_tools_user | length > 0

- name: Install system-scoped Python tools
  ansible.builtin.include_tasks: noauto_install_tools_system.yml
  when: python_tools_system | length > 0
